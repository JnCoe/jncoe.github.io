<!DOCTYPE HTML>
<!--
   Read Only by HTML5 UP
   html5up.net | @ajlkn
   Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
 -->
 <html>
 <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NJRJQG4Y13"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag() { dataLayer.push(arguments); }
   gtag('js', new Date());

   gtag('config', 'G-NJRJQG4Y13');
 </script>
 <!-- Global site tag (gtag.js) - Google Analytics -->
 <!-- Hotjar Tracking Code for https://jncoe.github.io/ -->
 <script>
   (function(h,o,t,j,a,r){
     h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
     h._hjSettings={hjid:3547449,hjsv:6};
     a=o.getElementsByTagName('head')[0];
     r=o.createElement('script');r.async=1;
     r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
     a.appendChild(r);
   })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
 </script>
 <title>Electoral Map</title>
 <meta charset="utf-8"/>
 <meta content="width=device-width, initial-scale=1" name="viewport"/>
 <link href="assets/css/main.css" rel="stylesheet"/>
 <link href="assets/css/timeline.css" rel="stylesheet"/>
 <link href="assets/css/cards.css" rel="stylesheet"/>
 <link href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text y=%22.9em%22 font-size=%2290%22&gt;ðŸŽ²&lt;/text&gt;&lt;/svg&gt;" rel="icon"/>
 <script async="" defer="" src="https://www.google.com/recaptcha/api.js"></script>
 <script src="assets/js/jquery.min.js"></script>
 <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet"/>
 <link href="css/app.css" rel="stylesheet">
 <script src="scripts/jquery.js"></script>
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
 <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
 <style>
  #embedContainer1 {
    width: 100%;
    height: 70vh;
  }

  select,
  input[type="text"] {
    width: 80%;
    max-width: 300px;
    padding: 5px;
    margin: 10px;
  }

  button {
    padding: 5px 10px;
    margin-top: 10px;
  }

  .suggestions {
    position: absolute;
    border: 1px solid #ccc;
    background: #fff;
    max-height: 150px;
    overflow: hidden;
    width: 200px;
    margin-left: 10px;
    display: none; /* Hidden by default */
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 4px;
    z-index: 100;
  }

  .suggestions div {
    padding: 10px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .suggestions div:hover {
    background: #f0f0f0;
  }

  .suggestions::-webkit-scrollbar {
    display: none; /* Hide scrollbar */
  }

  #filters {
    padding: 20px;
  }

  #filtersContainer {
    margin-right: 20px;
    padding-right: 20px;
    border-right: 2px solid #ccc;
  }

  #infoContainer {
    padding-left: 10px;
  }

  #infoContainer img {
    width: 100px;
    height: 120px;
    object-fit: cover;
    object-position: center top;
    margin-right: 15px;
    border-radius: 30%;
  }

  #infoContainer .grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }

  #infoContainer .grid div {
    background: white;
    padding: 15px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
  }

  #candidateList {
    padding: 10px;
    max-height: 300px;
    overflow-y: auto;
    max-width: 300px;
    background: white;
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
    scrollbar-width: thin; /* Firefox scrollbar styling */
    scrollbar-color: #cccccc #ffffff; /* Firefox - thumb and track */
  }

  /* Fancy scroll styling for Webkit browsers (e.g., Chrome, Safari) */
  #candidateList::-webkit-scrollbar {
    width: 8px;
  }

  #candidateList::-webkit-scrollbar-track {
    background: #f9f9f9;
    border-radius: 10px;
  }

  #candidateList::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 10px;
  }

  #candidateList::-webkit-scrollbar-thumb:hover {
    background: #b3b3b3;
  }

  .candidate-item {
    padding: 10px;
    margin: 10px 0;
    cursor: pointer;
    position: relative;
    background: white;
    border-radius: 8px; 
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .candidate-item.selected::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 5px;  /* Width of the accent bar */
    background: #5393ce;  /* Accent color */
    border-radius: 8px 0 0 8px; /* Match the box border radius on the left side */
    z-index: 5;
  }

  .candidate-item:hover {
    background: #f0f0f0;
  }

  @media (max-width: 760px) {
    .container {
      flex-direction: column;
    }

    #filtersContainer,
    #infoContainer {
      padding: 10px 0;
      border-right: none; /* Remove border when stacked vertically */
    }

    #infoContainer {
      order: 2; /* Display info below filters */
    }

    #filtersContainer {
      order: 1; /* Display filters on top */
      border-bottom: 2px solid #ccc; /* Add horizontal border */
      margin-bottom: 20px;
    }
  }
</style>
</link>
</head>
<body class="is-preload">
  <!-- Header -->
  <section id="header" style="font-family: 'cbuMono'">
   <header>
    <h2 id="logo" style="visibility: hidden;">MENU</h2>
  </header>
  <nav id="nav">
    <ul>
     <li class="menu"><a class="active" href="#context">CONTEXT</a></li>
     <li class="menu"><a href="#howto">HOW TO USE</a></li>
     <li class="menu"><a href="#filterssection">FILTERS</a></li>
     <li class="menu"><a href="#map">MAP</a></li>
   </ul>
 </nav>
 <footer>
  <ul class="icons">
   <li class="social"><a class="icon brands fa-linkedin" href="https://www.linkedin.com/in/jonasbarros/"><span class="label">Linkedin</span></a></li>
   <li class="social"><a class="icon brands fa-github" href="https://github.com/JnCoe"><span class="label">Github</span></a></li>
   <!--<li><a href="#" class="icon solid fa-envelope"><span class="label">Email</span></a></li>-->
 </ul>
 <p style="text-align: center; padding-top: 15px; font-size: x-small;"><a href="https://jncoe.github.io" >JONAS COELHO</a></p>
</footer>
</section>
<!-- Wrapper -->
<div id="wrapper">
 <!-- Main -->
 <div id="main">
  <section id="one">
   <div class="image main" data-position="center"></div>
 </section>
 <section id="topo">
   <div class="container">
    <header class="major">
     <h3 style="margin-bottom: 0;font-family: 'cbuMono'; font-size:3em;">ELECTORAL MAP</h3>
     <div class="typewriter">
      <p>Rio de Janeiro elections 2024</p>
    </div>
  </header>
</div>
</section>
<!-- One -->
<section id="context">
 <div class="container">
  <h3>CONTEXT</h3>
  <p>
   In the 2024 municipal election in Rio de Janeiro, voters cast their ballots in a system without electoral districts. This approach presents a challenge: it is impossible to determine where each candidate has the strongest voter support geographically. Despite this, the press rarely provides visual tools like maps to analyze the data, even though creating such maps is straightforward with tools like Python.
   This project aims to fill that gap by using vote data to plot a bubble map, revealing patterns of candidate support across the city. Beyond offering a novel perspective on the election, it demonstrates how data visualization can make complex electoral outcomes more accessible and meaningful.
 </p>
</div>
</section>
<!-- Two -->
<section id="howto">
 <div class="container">
  <h3>HOW TO USE</h3>

  <p><strong>Using the Election Map Tool</strong></p>

  <p>
    Start by selecting a position, party, or candidate from the filters below. Once you have chosen a candidate, the candidate's voting information will be loaded on the right. To see the voting patterns of the selected candidate across Rio de Janeiro City, click the "See candidate on the map" button.
  </p>

  <p>
    On the map, each bubble represents a voting location. The size of the bubble reflects the number of votes the candidate received in that location, while the color shows the proportion of votes for the candidate in that location. Size and color scale values are shown on the candidate information panel.
  </p>

  <p>
    To explore further details, hover over a bubble to see specific information, such as the voting location's address, total votes, and the candidate's vote share at that location.
  </p>



</div>
</section>
<section id="filterssection" style="width: 100%;">
  <div class="container" style="display: flex; flex-wrap: wrap; align-items: flex-start;">
    <!-- Left side (Filters) -->
    <div id="filtersContainer">
      <h3>FILTERS</h3>
      <h4>1. SELECT A POSITION:</h4>
      <select id="positionDropdown">
        <option selected="" value="Vereador">Councilman/Councilwoman</option>
        <option value="Prefeito">Mayor</option>
      </select>
      <h4 style="margin: 0">2. SELECT A PARTY:</h4><h7>(optional)</h7>
      <select id="partyDropdown">
        <option value="">All Parties</option>
      </select>
      <h4>3. SELECT A CANDIDATE:</h4>
      <input id="candidateSearch" placeholder="Search candidate..." type="text" />
      <div class="suggestions" id="candidateSuggestions"></div>
      <div id="candidateList" style="border: 1px solid #ccc; padding: 10px; max-height: 300px; overflow-y: scroll; overflow-x: clip;"></div>
  </div>

  <!-- Right side (Candidate Information) -->
  <div id="infoContainer" style="flex: 1; padding-left: 10px;">
    <!-- Main Box -->
    <div style="display: flex; align-items: center; background: white; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border-radius: 8px;">
      <img src="./placeholder.jpg" alt="Sample" style="width: 100px; height: 110px; object-fit: cover; margin-right: 15px; border-radius: 35%;">
      <div>
        <p style="margin: 0; font-weight: bold; background: linear-gradient(45deg, #6a11cb, #2575fc); -webkit-background-clip: text; -webkit-text-fill-color: #0000005c;">SELECT A CANDIDATE ON THE SIDE</p>
        <p style="margin: 0;"></p>
        <p style="margin: 0;"></p>
      </div>
    </div>

    <!-- 2x2 Grid -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: auto auto auto; gap: 15px;">
      <div style="background: white; padding: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border-radius: 8px;">
        <p style="text-align: center; margin-bottom: 5px;"></p><span style="
        display: inline-block;
        width: 10px;
        height: 10px;
        border: 1px solid rgba(145, 145, 145, 1); /* Fully opaque border */
        background-color: rgba(0, 0, 0, 0.2); /* 30% transparent inside */
        border-radius: 50%; /* Makes it a circle */
        vertical-align: middle; /* Aligns well with text or inline content */
        "></span>
      </div>
      <div style="background: white; padding: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border-radius: 8px;">
       <p style="text-align: center; margin-bottom: 5px;"></p><span style="
       display: inline-block;
       width: 30px;
       height: 30px;
       border: 1px solid rgba(145, 145, 145, 1); /* Fully opaque border */
       background-color: rgba(0, 0, 0, 0.2); /* 30% transparent inside */
       border-radius: 50%; /* Makes it a circle */
       vertical-align: middle; /* Aligns well with text or inline content */
       "></span>
     </div>
     <div style="background: linear-gradient(to right, #99999940, #a0d1ff40); padding: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border-radius: 8px;">

     </div>
     <div style="background: linear-gradient(to left, #6b232840, #a0d1ff40); padding: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border-radius: 8px;">

     </div>
     <div style="grid-column: span 2; background: #f9f9f9; padding: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border-radius: 8px;">

     </div>
     <div style="grid-column: span 2; background: #f9f9f9; padding: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border-radius: 8px;">

     </div>
   </div>
         <button id="applyButton" style="
      width: 85%; 
      margin: 20px auto; 
      padding: 15px 20px; 
      text-align: center; 
      font-weight: bold; 
      font-size: 16px; 
      color: #ffffff; 
      background: linear-gradient(to right, #4b79a1, #283e51); 
      border: none; 
      border-radius: 25px; 
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1); 
      cursor: pointer; 
      transition: all 0.3s ease;
      display: block; 
      ">
      See candidate on the map
    </button>
 </div>
</div>
</section>




<!-- Two -->
<section id="map">
 <div class="container"><h3>MAP</h3>
  <div id="embedContainer1"></div>
</div>
</section>
<!-- Footer -->
<section id="footer">
 <div class="container">
  <ul class="copyright">
   <li>Â© Some rights may be reserved.</li>
 </ul>
</div>
</section>
</div>
<!-- Scripts -->
<script src="assets/js/jquery.scrollex.min.js"></script>
<script src="assets/js/jquery.scrolly.min.js"></script>
<script src="assets/js/browser.min.js"></script>
<script src="assets/js/breakpoints.min.js"></script>
<script src="assets/js/util.js"></script>
<script src="assets/js/main.js"></script>
<script src="assets/js/cards.js"></script>
</div>
<script>
    let candidatesData = []; // Array to store CSV data
    window.selectedCandidate = null; // To store the selected candidate (using window for global scope)
    const DATA_REPO = "https://raw.githubusercontent.com/JnCoe/rio-electoral-data-2024/refs/heads/main";
    
    document.addEventListener("DOMContentLoaded", function () {
      console.log("DOMContentLoaded fired");
      const CANDIDATES_CSV_URL = `${DATA_REPO}/data/candidates.csv`;
      console.log("Fetching CSV from:", CANDIDATES_CSV_URL);
      
      Papa.parse(CANDIDATES_CSV_URL, {
        download: true,
        header: true,
        transformHeader: header => header.trim().toLowerCase(),
        complete: function (results) {
          console.log("Papa.parse complete callback triggered");
          console.log("Results data length:", results.data?.length);
          console.log("Sample raw row:", results.data?.[0]);
          candidatesData = results.data
            .map(row => ({
              ...row,
              sq_candidato: row.sq_candidato || row.sq_candidado,
              candidate: row.candidate || row.candidate_name || row.nome || row.name,
              party: row.party || row.partido || row.party_name,
              position: row.position || row.cargo,
              sum_votes: parseInt(row.sum_votes || row.total_votes || 0) || 0,
              count_local: parseInt(row.count_local || row.locations || 0) || 0,
              min_abs_votes: parseInt(row.min_abs_votes || 0) || 0,
              max_abs_votes: parseInt(row.max_abs_votes || 0) || 0,
              min_prop_votes: parseFloat(row.min_prop_votes || 0) || 0,
              max_prop_votes: parseFloat(row.max_prop_votes || 0) || 0
            }))
            .filter(row => row.candidate); // Store parsed data
          console.log("Processed candidatesData length:", candidatesData.length);
          console.log("Sample processed row:", candidatesData?.[0]);
          const uniquePositions = [...new Set(candidatesData.map(c => c.position))];
          console.log("Unique positions in data:", uniquePositions);
          initializeDropdowns(candidatesData);
          attachButtonListener(); // Attach button listener after data is loaded
        },
        error: function (error) {
          console.error("Papa.parse error:", error);
        }
      });
    });

    function initializeDropdowns(data) {
      console.log("initializeDropdowns called with data length:", data.length);
      console.log("Sample data positions:", data.slice(0, 10).map(d => d.position));
      const positionDropdown = document.getElementById('positionDropdown');
      const partyDropdown = document.getElementById('partyDropdown');
      const candidateDropdown = document.getElementById('candidateDropdown');
      const candidateSearch = document.getElementById('candidateSearch');
      const candidateSuggestions = document.getElementById('candidateSuggestions');

    // Extract unique parties for the dropdown
      const uniqueParties = [...new Set(data.map(item => item.party))].filter(p => p);
      console.log("Unique parties found:", uniqueParties.length, uniqueParties.slice(0, 5));

    // Populate Party Dropdown
      uniqueParties.forEach(party => {
        const option = document.createElement('option');
        option.value = party;
        option.textContent = party;
        partyDropdown.appendChild(option);
      });

    // Function to filter and display candidates
      function updateCandidateAndPartyDropdown() {
        console.log("updateCandidateAndPartyDropdown called");
        const positionDropdown = document.getElementById('positionDropdown');
        const partyDropdown = document.getElementById('partyDropdown');
        const candidateSearch = document.getElementById('candidateSearch');
        const candidateList = document.getElementById('candidateList');

        const selectedPosition = positionDropdown.value;
        const selectedParty = partyDropdown.value;
        const searchTerm = candidateSearch.value.toLowerCase();
        
        console.log("Filters:", { selectedPosition, selectedParty, searchTerm });
        console.log("candidatesData available:", window.candidatesData?.length || candidatesData?.length);
        console.log("Sample positions from candidatesData:", candidatesData?.slice(0, 20).map(c => ({ candidate: c.candidate, position: c.position })));

    // Filter candidates based on party and search term
        const filteredCandidates = candidatesData.filter(item =>
          (item.position === selectedPosition) &&
          (!selectedParty || selectedParty === 'All Parties' || item.party === selectedParty) &&
          (!searchTerm || (item.candidate || '').toLowerCase().includes(searchTerm)) &&
          item.candidate !== 'NULO' && !(item.candidate || '').startsWith('Legenda:') // Hide NULO and Legenda entries
          );
        
        console.log("Filtered candidates count:", filteredCandidates.length);

        // Sort candidates by total votes (descending)
        filteredCandidates.sort((a, b) => {
          const aVotes = Number(a.sum_votes) || 0;
          const bVotes = Number(b.sum_votes) || 0;
          return bVotes - aVotes;
        });

    // Clear previous candidates list
        candidateList.innerHTML = '';

    // Populate candidate list with filtered candidates
        filteredCandidates.forEach(candidate => {
          const candidateItem = document.createElement('div');
          candidateItem.className = 'candidate-item';
          candidateItem.style = `
          padding: 10px;
          margin: 10px 0;
          cursor: pointer;
          position: relative;
          background: white;
          border-radius: 8px; 
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
          overflow: hidden;
          `;

        // Create a bar proportional to the number of votes
          const voteBar = document.createElement('div');
          const totalVotes = Number(candidate.sum_votes) || 0;
          voteBar.style = `
          position: absolute;
          top: 0;
          left: 0;
          height: 100%;
          width: ${totalVotes / 1310}%; 
          background: rgb(232 232 232);
          z-index: 0;
          `;

// Create a label for the candidate name
          const candidateLabel = document.createElement('span');
          candidateLabel.textContent = candidate.candidate;
candidateLabel.style = 'position: relative; z-index: 1;'; // Ensure the text is above the bar

// Append elements
candidateItem.appendChild(voteBar);
candidateItem.appendChild(candidateLabel);


        // Add click event to select the candidate
candidateItem.addEventListener('click', () => {
    window.selectedCandidate = candidate.candidate; // Store the selected candidate
    updateCandidateInfo(window.selectedCandidate);  // Update candidate info as before

    // Remove the 'selected' class from all items
    document.querySelectorAll('.candidate-item').forEach(item => item.classList.remove('selected'));

    // Add the 'selected' class to the clicked item
    candidateItem.classList.add('selected');
});

candidateList.appendChild(candidateItem);
});
      }


    // Function to update the candidate info (image and text)
      function updateCandidateInfo(selectedCandidate) {
      if (!selectedCandidate) return; // Exit if no candidate selected

      // Find the selected candidate in the data
      const candidate = data.find(item => item.candidate === selectedCandidate);

      if (candidate) {
        // Extract details from candidate field
        const candidateText = candidate.candidate || '';
        let name, number, party;
        
        // Check if candidate text contains the expected format
        if (candidateText.includes(' - ') && candidateText.includes(' (')) {
          name = candidateText.split(" - ")[0];
          const numberAndParty = candidateText.split(" - ")[1];
          number = numberAndParty.split(" (")[0];
          party = numberAndParty.split(" (")[1].replace(")", "");
        } else {
          // Handle special cases like "NULO" or "Legenda"
          name = candidateText;
          number = candidate.number || '';
          party = candidate.party || '';
        }

        // Update the image
        const imageUrl = `${DATA_REPO}/data/candidates_pic/FRJ${candidate.sq_candidato}_div.jpg`;
        document.querySelector("#infoContainer img").src = imageUrl;

        // Update the text lines
        const infoContainer = document.querySelector("#infoContainer");
        const textLines = infoContainer.querySelectorAll("p");
        textLines[0].innerHTML = `<b>${name}</b>`;   // Line 1: Name
        textLines[1].innerHTML = `<b>PARTY:</b> ${party}`; // Line 2: Party
        textLines[2].innerHTML = `<b>NUMBER:</b> ${number}`; // Line 3: Number

        const gridContainer = infoContainer.children[1];
        const gridBoxes = gridContainer.querySelectorAll("div");
        const minVotes = Number(candidate.min_abs_votes) || 0;
        const maxVotes = Number(candidate.max_abs_votes) || 0;
        const totalVotes = Number(candidate.sum_votes) || 0;
        const totalLocations = Number(candidate.count_local) || 0;
        gridBoxes[0].querySelector("p").innerHTML = `<b>MINIMUM VOTES:</b></br>${minVotes.toLocaleString('en-US')}`;
        gridBoxes[1].querySelector("p").innerHTML = `<b>MAXIMUM VOTES:</b></br>${maxVotes.toLocaleString('en-US')}`;

        gridBoxes[2].innerHTML = `<b>MINIMUM SHARE OF VOTES:</b></br>${candidate.min_prop_votes}%`; // Box 1
        gridBoxes[3].innerHTML = `<b>MAXIMUM SHARE OF VOTES:</b></br>${candidate.max_prop_votes}%`; // Box 2
        gridBoxes[4].innerHTML = `<b>TOTAL VOTES:</b> ${totalVotes.toLocaleString('en-US')}`; // Box 1
        gridBoxes[5].innerHTML = `<b>TOTAL VOTING LOCATIONS:</b> ${totalLocations.toLocaleString('en-US')}`; // Box 2
      }
    }

    // Initial population of candidate dropdown
    updateCandidateAndPartyDropdown();

    // Add event listeners
    partyDropdown.addEventListener('change', updateCandidateAndPartyDropdown);
    positionDropdown.addEventListener('change', updateCandidateAndPartyDropdown);
    candidateSearch.addEventListener('input', updateCandidateAndPartyDropdown);
    candidateSearch.addEventListener('focus', () => {
      if (candidateSearch.value) {
        candidateSuggestions.style.display = 'block';
      }
    });
    candidateSearch.addEventListener('blur', () => {
      // Delay hiding to allow click selection
      setTimeout(() => {
        candidateSuggestions.style.display = 'none';
      }, 150);
    });

  }

    // Global variables for Leaflet map
    let map;
    let markersLayer;
    let votingLocations = {};

    // Initialize Leaflet map on page load
    window.addEventListener('load', async function() {
      // Initialize map
      map = L.map('embedContainer1').setView([-22.9068, -43.1729], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);
      
      markersLayer = L.featureGroup().addTo(map);
      
      // Load voting locations
      try {
        const response = await fetch(`${DATA_REPO}/data/processed/voting_locations_geocoded_cleaned.json`);
        votingLocations = await response.json();
        console.log(`Loaded ${Object.keys(votingLocations).length} voting locations`);
      } catch (error) {
        console.error('Failed to load voting locations:', error);
        alert('Unable to load map data. Please try again later.');
      }
    });

    // Function to load and display candidate votes on map
    async function loadCandidateVotes(candidateId, candidate) {
      const applyButton = document.getElementById('applyButton');
      const originalText = applyButton.textContent;
      
      // Clear existing markers
      markersLayer.clearLayers();
      
      // Show loading state
      applyButton.textContent = 'Loading map data...';
      applyButton.disabled = true;
      
      try {
        // Fetch candidate vote data
        const response = await fetch(`${DATA_REPO}/data/processed/votes_${candidateId}.json`);
        // Accept both 200 (success) and 304 (not modified - using cached data)
        if (!response.ok && response.status !== 304) throw new Error('Failed to load candidate data');
        
        const votes = await response.json();
        
        // Get min/max for scaling
        const minVotes = parseFloat(candidate.min_abs_votes);
        const maxVotes = parseFloat(candidate.max_abs_votes);
        const minProp = parseFloat(candidate.min_prop_votes);
        const maxProp = parseFloat(candidate.max_prop_votes);
        
        // Add markers for each voting location
        votes.forEach(vote => {
          const loc = votingLocations[vote.location_id];
          if (!loc || !loc.lat || !loc.lon) return; // Skip if location not found or has no coordinates
          
          const marker = L.circleMarker([loc.lat, loc.lon], {
            radius: scaleRadius(vote.votes, minVotes, maxVotes),
            fillColor: scaleColor(vote.proportion, minProp, maxProp),
            color: '#666',
            weight: 1,
            opacity: 0.8,
            fillOpacity: 0.6
          }).bindPopup(`
            <strong>${loc.name}</strong><br>
            ${loc.address}<br>
            <br>
            <strong>Votes:</strong> ${vote.votes.toLocaleString()}<br>
            <strong>Share:</strong> ${vote.proportion.toFixed(2)}%<br>
            <strong>Total at location:</strong> ${vote.total_votes_location.toLocaleString()}
          `);
          
          markersLayer.addLayer(marker);
        });
        
        // Zoom to fit all markers
        if (markersLayer.getLayers().length > 0) {
          map.fitBounds(markersLayer.getBounds(), { padding: [50, 50] });
        }
        
        // Scroll to map
        document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
        
      } catch (error) {
        console.error('Error loading candidate data:', error);
        console.error('Error details:', error.message, error.stack);
        alert(`Failed to load candidate data: ${error.message}. Please try again.`);
      } finally {
        applyButton.textContent = originalText;
        applyButton.disabled = false;
      }
    }
    
    // Scaling functions
    function scaleRadius(votes, min, max) {
      const minRadius = 5;
      const maxRadius = 30;
      if (max === min) return minRadius;
      return minRadius + ((votes - min) / (max - min)) * (maxRadius - minRadius);
    }
    
    function scaleColor(proportion, minProp, maxProp) {
      // Three-point gradient: grey (low) â†’ blue (middle) â†’ red (high)
      const lowColor = [153, 153, 153];  // #999999 - Grey for minimum
      const midColor = [160, 209, 255];  // #A0D1FF - Blue for average
      const highColor = [107, 35, 40];   // #6B2328 - Red for maximum
      
      if (maxProp === minProp) return `rgb(${midColor.join(',')})`;
      
      // Calculate the midpoint (average)
      const midProp = (minProp + maxProp) / 2;
      
      let normalized, r, g, b;
      
      if (proportion <= midProp) {
        // Interpolate between low and mid colors
        normalized = (proportion - minProp) / (midProp - minProp);
        r = Math.round(lowColor[0] + normalized * (midColor[0] - lowColor[0]));
        g = Math.round(lowColor[1] + normalized * (midColor[1] - lowColor[1]));
        b = Math.round(lowColor[2] + normalized * (midColor[2] - lowColor[2]));
      } else {
        // Interpolate between mid and high colors
        normalized = (proportion - midProp) / (maxProp - midProp);
        r = Math.round(midColor[0] + normalized * (highColor[0] - midColor[0]));
        g = Math.round(midColor[1] + normalized * (highColor[1] - midColor[1]));
        b = Math.round(midColor[2] + normalized * (highColor[2] - midColor[2]));
      }
      
      return `rgb(${r},${g},${b})`;
    }
    
    // Add event listener to "See candidate on the map" button
    function attachButtonListener() {
      const applyButton = document.getElementById('applyButton');
      if (applyButton) {
        applyButton.addEventListener('click', async () => {
          if (!window.selectedCandidate) {
            alert('Please select a candidate first');
            return;
          }
          
          // Find candidate data
          const candidate = candidatesData.find(c => c.candidate === window.selectedCandidate);
          if (!candidate) {
            alert('Candidate data not found');
            return;
          }
          
          await loadCandidateVotes(candidate.sq_candidato, candidate);
        });
      }
    }

    </script>
  </body>
  </html>